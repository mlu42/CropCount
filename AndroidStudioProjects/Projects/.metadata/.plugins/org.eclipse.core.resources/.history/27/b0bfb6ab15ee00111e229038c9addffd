package ipcm.tool.kit;

import java.io.IOException;
import java.io.InputStream;
import java.net.MalformedURLException;
import java.net.URL;
import java.util.ArrayList;

import org.xmlpull.v1.XmlPullParser;
import org.xmlpull.v1.XmlPullParserException;
import org.xmlpull.v1.XmlPullParserFactory;

import android.app.ListActivity;
import android.content.Context;
import android.content.Intent;
import android.content.res.Resources;
import android.database.Cursor;
import android.graphics.Color;
import android.net.Uri;
import android.os.Bundle;
import android.util.Log;
import android.view.View;
import android.widget.AdapterView;
import android.widget.AdapterView.OnItemSelectedListener;
import android.widget.ArrayAdapter;
import android.widget.ListView;
import android.widget.Spinner;

//import com.google.code.rome.android.repackaged.com.sun.syndication.feed.synd.SyndEntry;
//import com.google.code.rome.android.repackaged.com.sun.syndication.feed.synd.SyndFeed;
//import com.google.code.rome.android.repackaged.com.sun.syndication.io.SyndFeedInput;
//import com.google.code.rome.android.repackaged.com.sun.syndication.io.XmlReader;

public class Videos extends ListActivity{

	// Instance variables
	DataHelper db;
	final Context context = this;
	ArrayList<Playlist> playlists;
	ArrayList<YoutubeVideo> videos;
	ListView list;
	Spinner spinner;
	
	// The action performed when an item in the list is clicked on
	protected void onListItemClick(ListView l, View v, int position, long id){
		Log.d("link", videos.get(position).getUrl());
		Uri uri = Uri.parse(videos.get(position).getUrl());
		Intent intent = new Intent(Intent.ACTION_VIEW, uri);
		startActivity(intent);
	}
	
	public void onCreate(Bundle savedInstanceState)
	{
		super.onCreate(savedInstanceState);
		setContentView(R.layout.videos);
		
		// Initializing instance variables
		final Resources res = getResources();
		db = new DataHelper(this);
		playlists = new ArrayList<Playlist>();
		videos = new ArrayList<YoutubeVideo>();
		list = getListView();
		spinner = (Spinner) findViewById(R.id.playlist_spinner);
		
		// Open the database
		db.openForWrite();
		
		list.setCacheColorHint(Color.TRANSPARENT); // Prevent weird animations when a list item is clicked		
		
		playlists = getPlaylists();
		ArrayList<String> playlistNames = getPlaylistNames();
		ArrayAdapter<String> adapter = new ArrayAdapter<String>(context, android.R.layout.simple_spinner_item, playlistNames);
		adapter.setDropDownViewResource(android.R.layout.simple_spinner_dropdown_item);
		spinner.setAdapter(adapter);
		
		// If it has been more than an hour since the list has been refreshed, reload the list from the internet
		if(db.getTimeSince(DataHelper.ROW_ALLPLAYLISTS) > 3600000)
		{
			Log.d("updatingVideos", "from internet");
			videos = getAllVideos();
			list.setAdapter( new YoutubeAdapter(this, R.layout.videoitem, videos));
			db.saveAllYoutubeVids(videos);
			db.updateTime(DataHelper.ROW_ALLPLAYLISTS);
		}
		// else, load the cached version of the list in memory
		else
		{
			Log.d("updatingVideos", "from database");
			videos = db.getAllYoutubeVideos();
			list.setAdapter( new YoutubeAdapter(this, R.layout.videoitem, videos));
		}
		
		Log.d("videos", ((Integer)videos.size()).toString());
		
		db.close();
		
		spinner.setOnItemSelectedListener( new OnItemSelectedListener(){			

			public void onItemSelected(AdapterView<?> parent, View view,
					int pos, long id) {
				
					String playlist = playlists.get(pos).getTitle();
					list.setAdapter(new YoutubeAdapter(context, R.layout.videoitem, videos));
				
				
			}
	
			public void onNothingSelected(AdapterView<?> arg0) {
				
			}
		
		});
	}
	
	public ArrayList<YoutubeVideo> getAllVideosFromPlaylist(String playlist)
	{
		ArrayList<YoutubeVideo> vids = new ArrayList<YoutubeVideo>();
		
		for(YoutubeVideo video: videos)
		{
			if(video.getPlaylist().equals(playlist))
				vids.add(video);
		}
		
		return vids;
	}
	
	public InputStream getInputStream(URL url)
	{
		try{
			return url.openConnection().getInputStream();
		}catch(IOException e){
			return null;
		}
	}
	
	public ArrayList<Playlist> getPlaylists()
	{		
		ArrayList<Playlist> playlistsTemp = new ArrayList<Playlist>();
		ArrayList<String> names = new ArrayList<String>();
		ArrayList<String> urls = new ArrayList<String>();
		
		try{
			
			URL url = new URL("https://gdata.youtube.com/feeds/api/users/uwipm/playlists?v=2");
			
			XmlPullParserFactory factory = XmlPullParserFactory.newInstance();
			factory.setNamespaceAware(false);
			XmlPullParser xpp = factory.newPullParser();
			
			xpp.setInput(getInputStream(url), "UTF_8");
			
			boolean insideItem = false;
			int eventType = xpp.getEventType();
			
			while(eventType != XmlPullParser.END_DOCUMENT){
				if(eventType == XmlPullParser.START_TAG){
					if(xpp.getName().equalsIgnoreCase("entry")){
						insideItem = true;
					} else if(xpp.getName().equalsIgnoreCase("title")){
						if(insideItem)
							names.add(xpp.nextText());
					} else if(xpp.getName().equalsIgnoreCase("content")){
						if(insideItem)
							urls.add(xpp.getAttributeValue(1));
					}
					
				} else if(eventType == XmlPullParser.END_TAG &&
									xpp.getName().equalsIgnoreCase("entry")){
					insideItem = false;
				}
				
				eventType = xpp.next();
			}
			
			int min = min(names.size(), urls.size());
			for(int i = 0; i < min; i++)
			{
				playlistsTemp.add(new Playlist(names.get(i), urls.get(i)));
			}			
			
			
		}catch(MalformedURLException e){
			e.printStackTrace();
		}catch(XmlPullParserException e){
			e.printStackTrace();
		}catch(IOException e){
			e.printStackTrace();
		}
		
		return playlistsTemp;
		
		/*db.openForWrite();
		playlists.clear();
			
		try{
			
			URL feedUrl = new URL("https://gdata.youtube.com/feeds/api/users/uwipm/playlists?v=2");
			
			SyndFeedInput input = new SyndFeedInput();
			SyndFeed feed = input.build( new XmlReader(feedUrl));
			
			List<SyndEntry> entries = feed.getEntries();
			
			Iterator<SyndEntry> iter = entries.iterator();
			
			playlists.add(new Playlist("All playlists", ""));
			
			while(iter.hasNext())
			{
				SyndEntry curr = iter.next();
				
				playlists.add(new Playlist(curr.getTitle(), curr.getLink()));
			}
			
			db.saveAllPlaylists(playlists);
			
		}catch(Exception e){
			e.printStackTrace();
		}
			
		db.close();*/
	}
	
	private int min(int a, int b)
	{
	  if (b < a) {
		  Log.d("min", "" + b);
          return b;
      }
	  else {
		  Log.d("min", "" + a);
		  return a;
	  }
	  
	}
	
	private int min(int a, int b, int c)
	{
	  if (b < a) {
          a = b;
      }
      if (c < a) {
          a = c;
      }
      return a;
	}
	
	public ArrayList<String> getPlaylistNames()
	{
		ArrayList<String> names = new ArrayList<String>();
		names.add("All playlists");
		
		for(Playlist list: playlists)
		{
			names.add(list.getTitle());
		}
		
		return names;
	}
	
	public ArrayList<YoutubeVideo> getAllVideos()
	{
		db.openForWrite();
		
		ArrayList<YoutubeVideo> videosTemp = new ArrayList<YoutubeVideo>();
		
		/*if(db.getTimeSince(DataHelper.ROW_ALLPLAYLISTS) > 3600000)
		{*/			
			for(Playlist playlist: playlists)
			{				
				ArrayList<String> titles = new ArrayList<String>();
				ArrayList<String> playlists = new ArrayList<String>();
				ArrayList<String> urls = new ArrayList<String>();
				ArrayList<String> thumbnailUrls = new ArrayList<String>();
				
				try{
					Log.d("playlist", playlist.getUrl());
					URL url = new URL(playlist.getUrl());
					
					XmlPullParserFactory factory = XmlPullParserFactory.newInstance();
					factory.setNamespaceAware(false);
					XmlPullParser xpp = factory.newPullParser();
					
					xpp.setInput(getInputStream(url), "UTF_8");
					
					boolean insideItem = false;
					boolean foundThumbnail = false;
					int eventType = xpp.getEventType();
					
					while(eventType != XmlPullParser.END_DOCUMENT){
						if(eventType == XmlPullParser.START_TAG){
							if(xpp.getName().equalsIgnoreCase("entry")){
								insideItem = true;
							} else if(xpp.getName().equalsIgnoreCase("title")){
								if(insideItem)
								{
									titles.add(xpp.nextText());
									playlists.add(playlist.getTitle());
								}
							} else if(xpp.getName().equalsIgnoreCase("link")){
								if(insideItem)
									if(xpp.getAttributeValue(null, "rel").equals("alternate"))
										urls.add(xpp.getAttributeValue(null, "href"));
							} else if(xpp.getName().equalsIgnoreCase("media:thumbnail"))
								if(insideItem)
									if(xpp.getAttributeValue(null, "height").equals("90"))
										if(!foundThumbnail){
											foundThumbnail = true;
											thumbnailUrls.add(xpp.getAttributeValue(null, "url"));
										}									
							
						} else if(eventType == XmlPullParser.END_TAG &&
											xpp.getName().equalsIgnoreCase("entry")){
							insideItem = false;
							foundThumbnail = false;
						}
						
						eventType = xpp.next();
					}
					
					Log.d("titles", ((Integer)titles.size()).toString());
					Log.d("playlists", ((Integer)playlists.size()).toString());
					Log.d("urls", ((Integer)urls.size()).toString());
					Log.d("thumbnailUrls", ((Integer)thumbnailUrls.size()).toString());
					
					int min = min(titles.size(), playlists.size(), thumbnailUrls.size());					
					for(int i = 0; i < min; i++)
					{
						videosTemp.add(new YoutubeVideo(titles.get(i), playlists.get(i), urls.get(i), thumbnailUrls.get(i)));
					}			
					
					
				}catch(MalformedURLException e){
					e.printStackTrace();
				}catch(XmlPullParserException e){
					e.printStackTrace();
				}catch(IOException e){
					e.printStackTrace();
				}				
			}

			db.openForWrite();
			db.updateTime(DataHelper.ROW_ALLPLAYLISTS);
			db.saveAllYoutubeVids(videos);
			
		/*}
		else
		{
			videosTemp = db.getAllYoutubeVideos();
		}
	
		db.close();*/
		
		return videosTemp;
	}
	
//	private ArrayList<YoutubeVideo> updatePestsAndScoutingList()
//	{
//		DataHelper db = new DataHelper(this).openForWrite();
//		ArrayList<YoutubeVideo> videos = new ArrayList<YoutubeVideo>();
//		
//		if(db.getTime(db.ROW_PESTS) > 3600000)
//		{
//			try{
//				URL feedUrl = new URL("http://gdata.youtube.com/feeds/api/playlists/303519A632D4A923");
//				
//				SyndFeedInput input = new SyndFeedInput();
//				SyndFeed feed = input.build( new XmlReader(feedUrl));
//				
//				List<SyndEntry> entries = feed.getEntries();
//				
//				Iterator<SyndEntry> iter = entries.iterator();
//				
//				while(iter.hasNext())
//				{
//					SyndEntry curr = iter.next();
//					
//					videos.add(new YoutubeVideo(curr.getTitle(), "Pests and scouting"));
//				}
//			}catch(Exception e){
//				e.printStackTrace();
//			}
//			
//			db.updateTime(db.ROW_PESTS);
//			db.close();
//		}
//		else
//		{
//			videos = db.getAllYoutubeVideos();
//			
//			for(YoutubeVideo vid: videos)
//			{
//				if(!vid.getPlaylist().equals("Pests and scouting"))
//				{
//					videos.remove(vid);
//				}
//			}
//		}
//		
//		
//		return videos;
//	}
//	
//	private ArrayList<YoutubeVideo> updateCropHealthFertilityList()
//	{
//
//		ArrayList<YoutubeVideo> videos = new ArrayList<YoutubeVideo>();
//		
//		try{
//			URL feedUrl = new URL("http://gdata.youtube.com/feeds/api/playlists/F17555C62D9A378B");
//			
//			SyndFeedInput input = new SyndFeedInput();
//			SyndFeed feed = input.build( new XmlReader(feedUrl));
//			
//			List<SyndEntry> entries = feed.getEntries();
//			
//			Iterator<SyndEntry> iter = entries.iterator();
//			
//			while(iter.hasNext())
//			{
//				SyndEntry curr = iter.next();
//				
//				videos.add(new YoutubeVideo(curr.getTitle()));
//			}
//			
////			Log.d("feed", feed.toString());
//		}catch(Exception e){
//			e.printStackTrace();
//		}
//		
//		return videos;
//	}
//	
//	private ArrayList<YoutubeVideo> updateInvasiveWeedsList()
//	{
//
//		ArrayList<YoutubeVideo> videos = new ArrayList<YoutubeVideo>();
//		
//		try{
//			URL feedUrl = new URL("http://gdata.youtube.com/feeds/api/playlists/FD4F11EEE799E158");
//			
//			SyndFeedInput input = new SyndFeedInput();
//			SyndFeed feed = input.build( new XmlReader(feedUrl));
//			
//			List<SyndEntry> entries = feed.getEntries();
//			
//			Iterator<SyndEntry> iter = entries.iterator();
//			
//			while(iter.hasNext())
//			{
//				SyndEntry curr = iter.next();
//				
//				videos.add(new YoutubeVideo(curr.getTitle()));
//			}
//			
////			Log.d("feed", feed.toString());
//		}catch(Exception e){
//			e.printStackTrace();
//		}
//		
//		return videos;
//	}
//	
//	private ArrayList<YoutubeVideo> updateAllVideoList()
//	{
//		ArrayList<YoutubeVideo> list = updateInvasiveWeedsList();
//		list.addAll(updateCropHealthFertilityList());
//		list.addAll(updatePestsAndScoutingList());
//		return list;
//	}
	
}
